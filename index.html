<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงเวลาปฏิบัติหน้าที่ ครูโรงเรียนปากช่อง</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        #schoolLogo { max-height: 80px; width: auto; border-radius: 8px; }
        #clock { font-size: 1.1rem; font-weight: bold; }
        .teacher-photo { max-width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid #dee2e6; }
        .signature-pad-container { position: relative; width: 100%; height: 180px; background-color: #ffffff; cursor: crosshair; border: 1px solid #ced4da; border-radius: 0.375rem; }
        #signatureCanvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-radius: 0.375rem; }
        #videoFeed { width: 100%; height: auto; max-height: 240px; display: block; background-color: #343a40; }
        .captured-photo { max-height: 240px; display: block; margin-left: auto; margin-right: auto; background-color: #e9ecef; }
        .form-label { margin-bottom: 0.5rem; }
        .btn-group-camera button { margin: 0 5px; }
        .form-section {
             transition: opacity 0.4s ease-in-out, max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out, margin-bottom 0.4s ease-in-out;
             opacity: 0;
             max-height: 0;
             overflow: hidden;
             border-top: none;
             padding-top: 0 !important;
             margin-top: 0 !important;
             padding-bottom: 0 !important;
             margin-bottom: 0 !important;
             position: relative; /* Needed for overlay */
        }
        .form-section.visible {
            opacity: 1;
            max-height: 1500px; /* Increased for potential content */
            overflow: visible;
            border-top: 1px solid #dee2e6;
            padding-top: 1rem !important;
            margin-top: 1rem !important;
            padding-bottom: 1rem !important;
             margin-bottom: 0 !important;
        }
        #teacherInfo.visible {
            border-top: none; padding-top: 1rem !important; margin-top: 1rem !important;
            padding: 1rem; border: 1px solid #dee2e6; background-color: #f8f9fa; border-radius: .25rem;
        }
        #dutyStatusSection.visible { border-top: none; margin-top: 1rem !important; }
        #dutyTypeSection.visible, #remarksSection.visible { border-top: 1px solid #dee2e6; max-height: 500px; }
        #teacherLookupStatus { min-height: 1.2em; display: block; }
        .section-loading-overlay {
             position: absolute; top: 0; left: 0; right: 0; bottom: 0;
             background-color: rgba(255, 255, 255, 0.7); z-index: 10;
             display: flex; align-items: center; justify-content: center;
             opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .section-loading-overlay.visible { opacity: 1; pointer-events: all; }

        @media (max-width: 767.98px) {
            .teacher-photo { max-width: 100px; height: 100px; margin-bottom: 1rem; }
            #videoFeed, .captured-photo { max-height: 180px; }
            .signature-pad-container { height: 140px; }
        }
    </style>
</head>
<body>

    <div class="container mt-4 mb-5">
        <div class="card shadow-sm border-primary">
            <div class="card-header text-center bg-primary text-white p-3">
                <img src="https://lh5.googleusercontent.com/d/1BJtbFIOceoeaCmymH9sTHnligfmYfWU6" alt="โลโก้โรงเรียนปากช่อง" id="schoolLogo" class="mb-2 img-fluid">
                <h4 class="mb-1 mt-2">โรงเรียนปากช่อง</h4>
                <p class="mb-0 small">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษานครราชสีมา</p>
            </div>
            <div class="card-body p-4">
                <div id="clock" class="alert alert-info text-center shadow-sm" role="alert">
                    <i class="fas fa-clock me-2"></i> กำลังโหลดเวลา...
                </div>

                <form id="checkinForm" novalidate>
                    <div class="mb-3">
                        <label for="teacherId" class="form-label fw-bold"><i class="fas fa-id-card me-2 text-primary"></i>รหัสครูผู้สอน (สูงสุด 4 ตัว)</label>
                        <input type="text" class="form-control" id="teacherId" name="teacherId" required placeholder="กรอกรหัสครู 4 ตัวเพื่อค้นหา" maxlength="4">
                        <div id="teacherLookupStatus" class="form-text mt-1"></div>
                    </div>

                    <div id="teacherInfo" class="form-section mb-0">
                         <div class="row align-items-center">
                            <div class="col-md-3 text-center mb-3 mb-md-0">
                                <img src="https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9" alt="รูปครู" id="teacherPhoto" class="teacher-photo">
                            </div>
                            <div class="col-md-9">
                                <p class="mb-1"><strong><i class="fas fa-user me-2"></i>ชื่อ-สกุล:</strong> <span id="teacherName"></span></p>
                                <p class="mb-1"><strong><i class="fas fa-chalkboard-teacher me-2"></i>กลุ่มสาระฯ:</strong> <span id="teacherDepartment"></span></p>
                                <p class="mb-0"><strong><i class="fas fa-user-tie me-2"></i>ตำแหน่ง:</strong> <span id="teacherPosition"></span></p>
                                <input type="hidden" id="hiddenTeacherName" name="teacherName">
                                <input type="hidden" id="hiddenTeacherDepartment" name="teacherDepartment">
                            </div>
                        </div>
                    </div>

                    <div id="dutyStatusSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-clipboard-check me-2 text-primary"></i>สถานะการปฏิบัติหน้าที่</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusPresent" value="มา" required>
                            <label class="form-check-label" for="statusPresent"> <i class="fas fa-user-check text-success me-1"></i> มาปฏิบัติหน้าที่ </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusLeave" value="ลา">
                            <label class="form-check-label" for="statusLeave"> <i class="fas fa-calendar-times text-warning me-1"></i> ลา </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusBusinessTrip" value="ไปราชการ">
                            <label class="form-check-label" for="statusBusinessTrip"> <i class="fas fa-plane-departure text-info me-1"></i> ไปราชการ </label>
                        </div>
                         <div id="dutyStatusError" class="invalid-feedback d-block"></div>
                         <div class="section-loading-overlay" id="dutySubSectionsLoading">
                            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                         </div>
                    </div>

                    <div id="dutyTypeSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-tasks me-2 text-secondary"></i>เลือกการปฏิบัติหน้าที่</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyType" id="dutyGate" value="เวรยืนประตู">
                            <label class="form-check-label" for="dutyGate"> <i class="fas fa-door-open text-success me-1"></i> เวรยืนประตู </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyType" id="dutyBuilding" value="ตรวจอาคาร">
                            <label class="form-check-label" for="dutyBuilding"> <i class="fas fa-building text-warning me-1"></i> ตรวจอาคาร </label>
                        </div>
                        <div id="dutyTypeError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="remarksSection" class="form-section">
                        <label for="remarks" class="form-label fw-bold"><i class="fas fa-pencil-alt me-2 text-secondary"></i>หมายเหตุ (เหตุผล)</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="ระบุเหตุผลการลา หรือรายละเอียดการไปราชการ"></textarea>
                        <div id="remarksError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="locationSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-map-marker-alt me-2 text-danger"></i>ตำแหน่งที่ตั้งปัจจุบัน</label>
                        <div id="locationInfo" class="form-control" style="min-height: 40px; background-color: #e9ecef;">
                            <span class="text-muted">กำลังค้นหาตำแหน่ง...</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1" id="getLocationBtn" title="ลองค้นหาตำแหน่งอีกครั้ง"> <i class="fas fa-sync"></i> </button>
                        </div>
                        <input type="hidden" id="latitude" name="latitude"> <input type="hidden" id="longitude" name="longitude">
                        <div id="locationError" class="form-text text-danger mt-1"></div>
                    </div>

                    <div id="signatureSection" class="form-section">
                         <label for="signatureCanvas" class="form-label fw-bold"><i class="fas fa-signature me-2 text-success"></i>ลงลายมือชื่อ</label>
                         <div class="signature-pad-container"> <canvas id="signatureCanvas"></canvas> </div>
                         <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="resetSignatureBtn"><i class="fas fa-eraser me-1"></i> ล้างลายเซ็น</button>
                         <input type="hidden" id="signatureData" name="signatureData">
                         <div id="signatureError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="photoSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-camera me-2 text-info"></i>ถ่ายภาพยืนยัน ณ ขณะนั้น</label>
                        <div class="row g-3 align-items-start">
                            <div class="col-md-6">
                                <video id="videoFeed" playsinline autoplay muted class="img-fluid border rounded bg-dark"></video>
                                <canvas id="photoCanvas" style="display:none;"></canvas>
                            </div>
                            <div class="col-md-6 text-center">
                                <img id="capturedPhotoPreview" src="https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87" alt="ภาพที่ถ่าย" class="img-fluid border rounded mb-2 captured-photo">
                                <input type="hidden" id="photoData" name="photoData">
                            </div>
                        </div>
                        <div class="mt-2 text-center btn-group-camera">
                            <button type="button" class="btn btn-sm btn-info" id="startCameraBtn"><i class="fas fa-video me-1"></i> เปิดกล้อง</button>
                            <button type="button" class="btn btn-sm btn-success" id="capturePhotoBtn" disabled><i class="fas fa-camera-retro me-1"></i> ถ่ายภาพ</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetPhotoBtn" disabled><i class="fas fa-undo me-1"></i> ถ่ายใหม่</button>
                        </div>
                        <div id="cameraError" class="form-text text-danger mt-1 text-center"></div>
                        <div id="photoError" class="invalid-feedback d-block text-center"></div>
                    </div>

                    <div id="submitButtonSection" class="form-section d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-secondary btn-lg fw-bold shadow" id="submitBtn" disabled>
                           <i class="fas fa-times-circle me-2"></i> กรอกข้อมูลให้ครบ
                        </button>
                    </div>

                    <div id="statusMessage" class="mt-3"></div>

                </form>
            </div>
            <div class="card-footer text-muted text-center small p-2">
                 ระบบลงเวลาปฏิบัติหน้าที่ โรงเรียนปากช่อง
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvDmyWrFu2HBRYGYcixiKggub0TvsRbPBSNYAkxaKAc13STDlMUP6sRyVNeuPq83rnMQ/exec'; // !!! สำคัญ: ใส่ URL ที่ถูกต้อง !!!
            const TEACHER_LOOKUP_URL = SCRIPT_URL + '?action=getTeacherInfo&id=';
            const MORNING_START_TIME = "06:50";
            const MORNING_END_TIME = "13:00";
            const AFTERNOON_START_TIME = "16:30";
            const AFTERNOON_END_TIME = "23:00";
            // const ALLOWED_DAYS = [0, 1, 2, 3, 4, 5]; // เปิด comment ถ้าต้องการจำกัดวัน จันทร์-ศุกร์

            // --- DOM ELEMENTS (ประกาศให้ครบถ้วน) ---
            const clockElement = document.getElementById('clock');
            const checkinForm = document.getElementById('checkinForm');
            const teacherIdInput = document.getElementById('teacherId');
            const teacherLookupStatus = document.getElementById('teacherLookupStatus');
            const teacherInfoDiv = document.getElementById('teacherInfo');
            const dutyStatusSection = document.getElementById('dutyStatusSection');
            const dutyTypeSection = document.getElementById('dutyTypeSection');
            const remarksSection = document.getElementById('remarksSection');
            const locationSection = document.getElementById('locationSection');
            const signatureSection = document.getElementById('signatureSection');
            const photoSection = document.getElementById('photoSection');
            const submitButtonSection = document.getElementById('submitButtonSection');
            const dutySubSectionsLoading = document.getElementById('dutySubSectionsLoading');
            const teacherPhoto = document.getElementById('teacherPhoto');
            const teacherNameSpan = document.getElementById('teacherName');
            const teacherDepartmentSpan = document.getElementById('teacherDepartment');
            const teacherPositionSpan = document.getElementById('teacherPosition');
            const hiddenTeacherName = document.getElementById('hiddenTeacherName');
            const hiddenTeacherDepartment = document.getElementById('hiddenTeacherDepartment');
            const dutyStatusRadios = document.querySelectorAll('input[name="dutyStatus"]');
            const dutyTypeRadios = document.querySelectorAll('input[name="dutyType"]');
            const remarksInput = document.getElementById('remarks');
            const dutyStatusErrorDiv = document.getElementById('dutyStatusError');
            const dutyTypeErrorDiv = document.getElementById('dutyTypeError');
            const remarksErrorDiv = document.getElementById('remarksError');
            const locationInfoDiv = document.getElementById('locationInfo');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const locationErrorDiv = document.getElementById('locationError');
            const signatureCanvas = document.getElementById('signatureCanvas');
            const resetSignatureBtn = document.getElementById('resetSignatureBtn');
            const signatureDataInput = document.getElementById('signatureData');
            const signatureErrorDiv = document.getElementById('signatureError');
            const videoFeed = document.getElementById('videoFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const capturedPhotoPreview = document.getElementById('capturedPhotoPreview');
            const photoDataInput = document.getElementById('photoData');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const resetPhotoBtn = document.getElementById('resetPhotoBtn');
            const cameraErrorDiv = document.getElementById('cameraError');
            const photoErrorDiv = document.getElementById('photoError');
            const submitBtn = document.getElementById('submitBtn');
            const statusMessage = document.getElementById('statusMessage');

            // --- STATE VARIABLES ---
            let signaturePad;
            let stream = null;
            let teacherDataCache = null;
            let locationWatcher = null;
            let isSubmitting = false;
            let checkinAllowed = false;
            let currentCheckinWindow = null; // 'morning', 'afternoon', or null
            let locationAcquired = false;

            // --- INITIALIZATION ---
            initializeClock();
            initializeSignaturePad();
            setInterval(updateClockAndButtonState, 1000);
            window.addEventListener('resize', resizeCanvas);
            addCompletionCheckListeners();
            hideAllSections(); // Ensure everything starts hidden

            // --- FUNCTIONS ---

            // 1. Clock and Time Check
            function initializeClock() { updateClockAndButtonState(); }

            function isWithinWindow(currentTimeStr, startTimeStr, endTimeStr) {
                return currentTimeStr >= startTimeStr && currentTimeStr <= endTimeStr;
            }

            function updateClockAndButtonState() {
                if (isSubmitting) return;
                const now = new Date();
                const year = now.getFullYear() + 543;
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                const thaiDate = now.toLocaleDateString('th-TH', optionsDate).replace(String(now.getFullYear()), String(year));
                const thaiTime = now.toLocaleTimeString('th-TH', optionsTime);
                clockElement.innerHTML = `<i class="fas fa-clock me-2"></i> ${thaiDate} เวลา ${thaiTime} น.`;

                const currentDay = now.getDay();
                const currentTimeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });

                // --- (Optional) Check Working Day ---
                // const isWorkingDay = typeof ALLOWED_DAYS !== 'undefined' ? ALLOWED_DAYS.includes(currentDay) : true;
                const isWorkingDay = true; // Assume everyday for now based on request

                checkinAllowed = false;
                currentCheckinWindow = null;

                if (isWorkingDay) {
                    if (isWithinWindow(currentTimeStr, MORNING_START_TIME, MORNING_END_TIME)) {
                        checkinAllowed = true;
                        currentCheckinWindow = 'morning';
                    } else if (isWithinWindow(currentTimeStr, AFTERNOON_START_TIME, AFTERNOON_END_TIME)) {
                        checkinAllowed = true;
                        currentCheckinWindow = 'afternoon';
                    }
                }
                // console.log(`Checkin Allowed: ${checkinAllowed}, Window: ${currentCheckinWindow}`);

                updateSubmitButtonDisplay();
            }

            // 2. Teacher ID Input & Lookup Trigger
            teacherIdInput.addEventListener('input', handleTeacherIdInput);
            teacherIdInput.addEventListener('paste', (e) => { setTimeout(handleTeacherIdInput, 0); });

            function handleTeacherIdInput() {
                 const currentVal = teacherIdInput.value.trim();
                 teacherIdInput.value = currentVal;

                 if (currentVal.length === 4) {
                     showLoadingAndFetch(currentVal);
                 } else {
                     if (teacherDataCache) { // Only hide if data was previously shown
                         hideAllSections();
                         teacherLookupStatus.textContent = 'กรุณากรอกรหัส 4 ตัว';
                     }
                 }
            }

            function showLoadingAndFetch(teacherId) {
                 teacherLookupStatus.textContent = '';
                 Swal.fire({
                     title: 'กำลังค้นหาข้อมูลครู...', text: `รหัส: ${teacherId}`,
                     allowOutsideClick: false, allowEscapeKey: false,
                     didOpen: () => { Swal.showLoading(); }
                 });
                 hideAllSections(false); // Hide sections but keep ID
                 fetchTeacherData(teacherId);
            }

            async function fetchTeacherData(teacherId) {
                 if (!teacherId) { Swal.close(); return; }
                 teacherDataCache = null;

                 if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                     Swal.close();
                     showSweetAlert('error', 'ตั้งค่าผิดพลาด', 'กรุณาตั้งค่า URL ของ Apps Script');
                     return;
                 }

                try {
                    const lookupUrl = `${TEACHER_LOOKUP_URL}${encodeURIComponent(teacherId)}`;
                    const response = await fetch(lookupUrl);
                    Swal.close();

                    if (!response.ok) throw new Error(`Server Connection Error (Status: ${response.status})`);
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        const text = await response.text(); console.error("Non-JSON response:", text);
                        throw new Error("Invalid server response format");
                    }
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    if (data.found && data.teacher) {
                        teacherDataCache = data.teacher; // Set cache HERE
                        console.log('>>> teacherDataCache SET:', teacherDataCache); // LOG
                        teacherNameSpan.textContent = data.teacher.name || 'N/A';
                        teacherDepartmentSpan.textContent = data.teacher.department || 'N/A';
                        teacherPositionSpan.textContent = data.teacher.position || 'N/A';
                        teacherPhoto.src = data.teacher.photoUrl || 'https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9';
                        teacherPhoto.alt = `รูปภาพ ${data.teacher.name || 'ครู'}`;
                        hiddenTeacherName.value = data.teacher.name || '';
                        hiddenTeacherDepartment.value = data.teacher.department || '';

                        showBaseInfoAndDutyStatus(); // Show sections AFTER setting cache
                        showSweetAlert('success', 'พบข้อมูลครู', `ชื่อ: ${data.teacher.name || 'N/A'}`);
                    } else {
                         throw new Error('ไม่พบข้อมูลครูสำหรับรหัสนี้');
                    }
                } catch (error) {
                     Swal.close(); console.error('Error fetching teacher data:', error);
                     showSweetAlert('error', 'เกิดข้อผิดพลาด', error.message);
                     hideAllSections();
                     teacherIdInput.focus();
                     teacherDataCache = null; // Ensure cache is null on error
                }
            }

            // 3. Show/Hide Sections Logic
            function showBaseInfoAndDutyStatus() {
                // Do NOT hide sections here again
                teacherInfoDiv.classList.add('visible');
                dutyStatusSection.classList.add('visible');
                dutyStatusRadios.forEach(radio => radio.checked = false); // Reset status selection
                // Ensure other sections are hidden initially after lookup
                dutyTypeSection.classList.remove('visible');
                remarksSection.classList.remove('visible');
                locationSection.classList.remove('visible');
                signatureSection.classList.remove('visible');
                photoSection.classList.remove('visible');
                submitButtonSection.classList.remove('visible');
            }

            function hideAllSections(clearTeacherId = true) {
                console.log(`>>> hideAllSections called (clearTeacherId=${clearTeacherId})`); // LOG
                document.querySelectorAll('.form-section').forEach(section => {
                    section.classList.remove('visible');
                });
                if (teacherDataCache) { // Only log clear if it had data
                    teacherDataCache = null;
                    console.log('>>> teacherDataCache CLEARED by hideAllSections'); // LOG
                }
                hiddenTeacherName.value = ''; hiddenTeacherDepartment.value = '';
                locationAcquired = false;
                if (clearTeacherId) {
                    teacherIdInput.value = '';
                    teacherLookupStatus.textContent = 'กรุณากรอกรหัส 4 ตัว';
                }
                clearValidationErrors(); statusMessage.innerHTML = '';
                stopCameraStream(); // Stop camera if running
                if (signaturePad) signaturePad.clear(); // Clear signature
                signatureDataInput.value = ''; photoDataInput.value = ''; // Clear hidden data
                latitudeInput.value = ''; longitudeInput.value = '';
                // Reset camera preview
                capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';
                startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true;
            }

            // 4. Duty Status Change Handler
            dutyStatusRadios.forEach(radio => { radio.addEventListener('change', handleDutyStatusChange); });

            async function handleDutyStatusChange() {
                 const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;
                 clearValidationErrors(['dutyStatusError']);
                 dutySubSectionsLoading.classList.add('visible'); // Show loading

                 // Hide all potentially visible sub-sections first
                 dutyTypeSection.classList.remove('visible'); remarksSection.classList.remove('visible');
                 locationSection.classList.remove('visible'); signatureSection.classList.remove('visible');
                 photoSection.classList.remove('visible'); submitButtonSection.classList.remove('visible');

                 // Reset dependent inputs/states
                 dutyTypeRadios.forEach(r => { r.checked = false; r.required = false; });
                 remarksInput.value = ''; remarksInput.required = false;
                 locationAcquired = false; // Reset location flag
                 // Clear signature/photo only if switching *away* from 'มา'? Or always? Let's clear always for simplicity.
                 if (signaturePad) signaturePad.clear();
                 signatureDataInput.value = ''; photoDataInput.value = '';
                 latitudeInput.value = ''; longitudeInput.value = '';
                  // Reset camera preview
                  capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';
                  startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                  capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true;
                  stopCameraStream(); // Ensure camera stops if switching away from 'มา'


                 await new Promise(resolve => setTimeout(resolve, 50)); // Shorter delay

                 if (selectedStatus === 'มา') {
                     dutyTypeSection.classList.add('visible'); locationSection.classList.add('visible');
                     signatureSection.classList.add('visible'); photoSection.classList.add('visible');
                     remarksSection.classList.remove('visible');
                     dutyTypeRadios.forEach(r => r.required = true); remarksInput.required = false;
                     initializeGeolocation(); resizeCanvas(); // startCamera(); // Let user click start camera
                 } else if (selectedStatus === 'ลา' || selectedStatus === 'ไปราชการ') {
                     remarksSection.classList.add('visible');
                     dutyTypeSection.classList.remove('visible'); locationSection.classList.remove('visible');
                     signatureSection.classList.remove('visible'); photoSection.classList.remove('visible');
                     dutyTypeRadios.forEach(r => r.required = false); remarksInput.required = true;
                     // stopCameraStream(); // Already called above
                 }

                 dutySubSectionsLoading.classList.remove('visible'); // Hide loading
                 checkFormCompletion(); // Check completion status
            }

            // 5. Geolocation
            getLocationBtn.addEventListener('click', initializeGeolocation);

            function initializeGeolocation() { /* ... (เหมือนเดิม, แต่มีการเรียก checkFormCompletion() ใน success/error callback) ... */
                if (!locationSection.classList.contains('visible')) return;
                locationInfoDiv.querySelector('span').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> กำลังค้นหา...';
                locationErrorDiv.textContent = ''; latitudeInput.value = ''; longitudeInput.value = '';
                locationAcquired = false; clearValidationErrors(['locationError']); checkFormCompletion();

                if ('geolocation' in navigator) {
                     if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                     navigator.geolocation.getCurrentPosition(
                         (position) => {
                             const lat = position.coords.latitude; const lon = position.coords.longitude;
                             latitudeInput.value = lat; longitudeInput.value = lon;
                             locationInfoDiv.querySelector('span').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                             locationAcquired = true; checkFormCompletion(); // Update flag and check completion
                             const mapLink = `https://www.google.com/maps?q=$${lat},${lon}`;
                             let linkElement = locationInfoDiv.querySelector('a');
                             if (!linkElement) {
                                 linkElement = document.createElement('a'); linkElement.target = '_blank'; linkElement.rel = 'noopener noreferrer';
                                 linkElement.classList.add('ms-2', 'small'); linkElement.innerHTML = '<i class="fas fa-external-link-alt"></i> ดูแผนที่';
                                 locationInfoDiv.appendChild(linkElement);
                             }
                             linkElement.href = mapLink;
                         },
                         (error) => { handleLocationError(error); locationAcquired = false; checkFormCompletion(); }, // Check completion on error too
                         { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                     );
                } else { handleLocationError({ code: -1, message: 'เบราว์เซอร์นี้ไม่รองรับ Geolocation' }); locationAcquired = false; checkFormCompletion(); }
            }
             function handleLocationError(error) { /* ... (เหมือนเดิม) ... */
                 console.error('Geolocation error:', error);
                 let message = 'ไม่สามารถรับตำแหน่งได้: ';
                  switch (error.code) { /* ... */ }
                 locationInfoDiv.querySelector('span').textContent = 'ข้อผิดพลาดในการรับตำแหน่ง';
                 locationErrorDiv.textContent = message; latitudeInput.value = ''; longitudeInput.value = '';
            }

            // 6. Signature Pad
            function initializeSignaturePad() { /* ... (เหมือนเดิม, มีการเรียก checkFormCompletion() ใน endStroke และ clear) ... */
                 resizeCanvas();
                 signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                 resetSignatureBtn.addEventListener('click', () => {
                     signaturePad.clear(); signatureDataInput.value = '';
                     clearValidationErrors(['signatureError']); checkFormCompletion(); // Check on clear
                 });
                 signatureCanvas.addEventListener('pointerdown', () => { clearValidationErrors(['signatureError']); });
                 signaturePad.addEventListener("endStroke", () => {
                     signatureDataInput.value = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/jpeg', 0.85).split(',')[1];
                     checkFormCompletion(); // Check on end stroke
                 });
            }
            function resizeCanvas() { /* ... (เหมือนเดิม) ... */
                 if (!signatureCanvas.offsetParent) return;
                 const ratio = Math.max(window.devicePixelRatio || 1, 1);
                 const canvasContainer = signatureCanvas.parentElement; if (!canvasContainer || canvasContainer.offsetWidth === 0) return;
                 signatureCanvas.width = canvasContainer.offsetWidth * ratio; signatureCanvas.height = canvasContainer.offsetHeight * ratio;
                 signatureCanvas.getContext("2d").scale(ratio, ratio);
                  if (signaturePad) { const data = signaturePad.toData(); signaturePad.clear(); signaturePad.fromData(data); }
            }

            // 7. Camera Functionality
            function stopCameraStream() { /* ... (เหมือนเดิม) ... */
                 if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; videoFeed.srcObject = null; console.log("Camera stream stopped."); }
             }
            startCameraBtn.addEventListener('click', startCamera);
            capturePhotoBtn.addEventListener('click', capturePhoto);
            resetPhotoBtn.addEventListener('click', resetPhoto);

            async function startCamera() { /* ... (เหมือนเดิม, มี checkFormCompletion) ... */
                if (!photoSection.classList.contains('visible')) return;
                cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = ''; clearValidationErrors(['cameraError', 'photoError']);
                stopCameraStream(); await new Promise(resolve => setTimeout(resolve, 100));
                try {
                     stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                     videoFeed.srcObject = stream; videoFeed.style.display = 'block';
                     capturePhotoBtn.disabled = false; resetPhotoBtn.disabled = true;
                     startCameraBtn.innerHTML = '<i class="fas fa-sync me-1"></i> รีสตาร์ทกล้อง';
                     capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E';
                     photoDataInput.value = ''; checkFormCompletion(); // Check after starting
                 } catch (err) { /* ... (error handling, checkFormCompletion) ... */
                    console.error("Camera Error:", err.name, err.message); let errorMsg = `กล้องผิดพลาด: ${err.name}`; /*...*/ cameraErrorDiv.textContent = errorMsg;
                    capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true; startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                    videoFeed.style.display = 'none'; stopCameraStream(); checkFormCompletion();
                 }
             }
            function capturePhoto() { /* ... (เหมือนเดิม, มี checkFormCompletion) ... */
                 if (!stream || !stream.active) { cameraErrorDiv.textContent = 'กรุณาเปิดกล้องก่อน'; return; }
                 clearValidationErrors(['photoError']);
                 const videoWidth = videoFeed.videoWidth; const videoHeight = videoFeed.videoHeight; if (!videoWidth || !videoHeight) { cameraErrorDiv.textContent = 'ขนาดวิดีโอผิดพลาด'; return; }
                 photoCanvas.width = videoWidth; photoCanvas.height = videoHeight;
                 const context = photoCanvas.getContext('2d'); context.drawImage(videoFeed, 0, 0, videoWidth, videoHeight);
                 const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.85);
                 capturedPhotoPreview.src = dataUrl; capturedPhotoPreview.alt = 'ภาพที่ถ่าย';
                 photoDataInput.value = dataUrl.split(',')[1]; // Store base64 data
                 resetPhotoBtn.disabled = false; capturePhotoBtn.disabled = true;
                 checkFormCompletion(); // Check after capture
            }
            function resetPhoto() { /* ... (เหมือนเดิม, มี checkFormCompletion) ... */
                 clearValidationErrors(['photoError']); photoDataInput.value = ''; // Clear photo data
                 capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E';
                 photoCanvas.getContext('2d').clearRect(0, 0, photoCanvas.width, photoCanvas.height);
                 resetPhotoBtn.disabled = true;
                 if (stream && stream.active) { capturePhotoBtn.disabled = false; }
                 else { capturePhotoBtn.disabled = true; }
                 checkFormCompletion(); // Check after reset
            }

            // 8. Form Completion Check
            function addCompletionCheckListeners() {
                dutyTypeRadios.forEach(r => r.addEventListener('change', checkFormCompletion));
                remarksInput.addEventListener('input', checkFormCompletion);
                // Others handled by their specific functions
            }

            function checkFormCompletion() {
                const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;
                let isComplete = false;

                if (selectedStatus === 'มา') {
                    const dutyTypeSelected = document.querySelector('input[name="dutyType"]:checked');
                    const signatureDone = !signaturePad.isEmpty() && signatureDataInput.value;
                    const photoTaken = photoDataInput.value;
                    // Use latitudeInput value as a proxy for locationAcquired being successful enough for submission check
                    isComplete = dutyTypeSelected && latitudeInput.value && longitudeInput.value && signatureDone && photoTaken;
                } else if (selectedStatus === 'ลา' || selectedStatus === 'ไปราชการ') {
                    isComplete = remarksInput.value.trim() !== '';
                }

                if (isComplete) { submitButtonSection.classList.add('visible'); }
                else { submitButtonSection.classList.remove('visible'); }
                updateSubmitButtonDisplay(); // Update enabled state based on time
            }

            // 9. Update Submit Button Display
            function updateSubmitButtonDisplay() {
                 if (!submitButtonSection.classList.contains('visible')) { submitBtn.disabled = true; return; }
                 if (checkinAllowed) {
                     submitBtn.disabled = false; submitBtn.classList.remove('btn-secondary'); submitBtn.classList.add('btn-primary');
                     const windowText = currentCheckinWindow === 'morning' ? 'เช้า' : (currentCheckinWindow === 'afternoon' ? 'บ่าย' : '');
                     submitBtn.innerHTML = `<i class="fas fa-paper-plane me-2"></i> ส่งข้อมูล ${windowText ? '(รอบ' + windowText + ')' : ''}`;
                 } else {
                     submitBtn.disabled = true; submitBtn.classList.remove('btn-primary'); submitBtn.classList.add('btn-secondary');
                     submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> นอกเวลาทำการ (${MORNING_START_TIME}-${MORNING_END_TIME} หรือ ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME})`;
                 }
            }

            // 10. Form Validation (Final Check)
            function validateForm() {
                // console.log("--- เริ่ม validateForm ---");
                // console.log("   ค่า teacherDataCache ก่อนเริ่ม validate:", teacherDataCache);
                clearValidationErrors();
                let isValid = true;
                const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');
                const statusValue = selectedStatusRadio ? selectedStatusRadio.value : null;
                // console.log("สถานะที่เลือก:", statusValue);

                if (!teacherDataCache) {
                    // console.log("Validate Fail: ไม่มีข้อมูลครู (teacherDataCache is null)");
                    showSweetAlert('warning', 'ข้อผิดพลาด', 'ไม่พบข้อมูลครู กรุณากรอกรหัสใหม่อีกครั้ง'); isValid = false;
                }
                else if (!statusValue) {
                    // console.log("Validate Fail: ไม่ได้เลือกสถานะ");
                    dutyStatusErrorDiv.textContent = 'กรุณาเลือกสถานะการปฏิบัติหน้าที่'; isValid = false;
                }
                else if (statusValue === 'มา') {
                    const dutyTypeSelected = document.querySelector('input[name="dutyType"]:checked');
                    const isSigEmpty = signaturePad.isEmpty();
                    const sigDataValue = signatureDataInput.value; const photoDataValue = photoDataInput.value;
                    const latValue = latitudeInput.value; const lonValue = longitudeInput.value;

                    if (!dutyTypeSelected) { /*...*/ dutyTypeErrorDiv.textContent = 'เลือกประเภทเวร'; isValid = false; }
                    else if (!latValue || !lonValue) { /*...*/ locationErrorDiv.textContent = 'ไม่มีค่าพิกัด'; isValid = false; }
                    else if (isSigEmpty || !sigDataValue) { /*...*/ signatureErrorDiv.textContent = 'ไม่มีลายเซ็น'; isValid = false; }
                    else if (!photoDataValue) { /*...*/ photoErrorDiv.textContent = 'ไม่มีรูปภาพ'; isValid = false; }
                }
                else if ((statusValue === 'ลา' || statusValue === 'ไปราชการ')) {
                    const remarksValue = remarksInput.value.trim();
                    if (!remarksValue) { /*...*/ remarksErrorDiv.textContent = 'ไม่มีหมายเหตุ'; isValid = false; }
                }

                // console.log("ตรวจสอบเวลา: checkinAllowed =", checkinAllowed);
                if (isValid && !checkinAllowed) {
                    // console.log("   Validate Fail: นอกเวลาทำการ");
                    showSweetAlert('warning', 'นอกเวลาทำการ', `ลงเวลาได้เฉพาะ ${MORNING_START_TIME}-${MORNING_END_TIME} หรือ ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME}`); isValid = false;
                }

                // Scroll to the first error
                 if (!isValid) {
                    const firstError = checkinForm.querySelector('.form-text.text-danger:not(:empty), .invalid-feedback:not(:empty)');
                    if(firstError) { firstError.closest('.form-section')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                 }

                // console.log(`--- จบ validateForm --- isValid = ${isValid}`);
                return isValid;
            }

            function clearValidationErrors(exceptIds = []) { /* ... (เหมือนเดิม) ... */
                 const errorDivs = checkinForm.querySelectorAll('.form-text.text-danger, .invalid-feedback');
                 errorDivs.forEach(div => { if (!exceptIds.includes(div.id)) { div.textContent = ''; } });
             }

            // 11. SweetAlert Helpers
            function showSweetAlert(icon, title, htmlContent = '') { /* ... (เหมือนเดิม) ... */ Swal.fire({ icon: icon, title: title, html: htmlContent, confirmButtonText: 'ปิด' }); }
            function showSuccessSweetAlert(checkinTime, teacherName, photoDataUrl) { /* ... (เหมือนเดิม) ... */
                Swal.fire({ icon: 'success', title: 'บันทึกข้อมูลสำเร็จ',
                     html: `<p><strong>วันที่/เวลา:</strong> ${checkinTime}</p><p><strong>ผู้บันทึก:</strong> ${teacherName}</p>${photoDataUrl ? `<img src="${photoDataUrl}" alt="ภาพเช็คอิน" style="max-width: 150px; max-height: 150px; margin-top: 10px; border-radius: 5px;">` : ''}`,
                     confirmButtonText: 'ปิด' });
            }

            // 12. Form Submission
            checkinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // --- Initial Checks ---
                if (!checkinAllowed) { /*...*/ showSweetAlert('warning', 'นอกเวลาทำการ', `...`); return; }
                if (!validateForm()) { /* validateForm shows its own alert */ return; }
                if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') { /*...*/ showSweetAlert('error', 'ตั้งค่าผิดพลาด', '...'); return; }

                // --- Confirmation Swal ---
                Swal.fire({
                    title: 'ยืนยันการส่งข้อมูล', html: "ต้องการส่งข้อมูลการลงเวลาใช่หรือไม่?", icon: 'question',
                    showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
                    confirmButtonText: ' ใช่, ส่งข้อมูล ', cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // --- Saving Swal ---
                        Swal.fire({ title: 'กำลังบันทึกข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, allowEscapeKey: false, didOpen: () => { Swal.showLoading(); } });
                        isSubmitting = true; statusMessage.innerHTML = '';
                        const formData = new FormData(checkinForm);
                        // ... (Prepare formData: set signature, delete unused fields) ...
                        if (formData.get('dutyStatus') === 'มา' && !signaturePad.isEmpty()) { formData.set('signatureData', signaturePad.toDataURL('image/jpeg', 0.85).split(',')[1]); }
                        else if (formData.get('dutyStatus') !== 'มา') { formData.set('signatureData', ''); }
                        const status = formData.get('dutyStatus');
                        if (status !== 'มา') { formData.delete('dutyType'); formData.delete('latitude'); formData.delete('longitude'); formData.delete('signatureData'); formData.delete('photoData'); }
                        else { formData.delete('remarks'); }
                        formData.append('clientTimestamp', new Date().toISOString());

                        // --- Fetch in try/catch/finally ---
                        let fetchSuccess = false; let successData = null;
                        try {
                            const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                            const contentType = response.headers.get("content-type"); let fetchResult;
                            if (contentType && contentType.includes("application/json")) { fetchResult = await response.json(); }
                            else { const text = await response.text(); throw new Error(text || `Server Error ${response.status}`); }

                            if (fetchResult.status === 'success') {
                                fetchSuccess = true;
                                const now = new Date(); const opts = { /*...*/ weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                                const thaiDateTime = now.toLocaleDateString('th-TH', opts).replace(String(now.getFullYear()), String(now.getFullYear() + 543));
                                const photoDataUrl = formData.get('photoData') ? `data:image/jpeg;base64,${formData.get('photoData')}` : null;
                                successData = { thaiDateTime, status, photoDataUrl };
                            } else {
                                // Throw specific error from server response message
                                throw new Error(fetchResult.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุจากเซิร์ฟเวอร์');
                            }
                        } catch (error) {
                            console.error('Error submitting form:', error);
                            if (Swal.isLoading()) Swal.close(); // Close loading Swal before showing error
                            showSweetAlert('error', 'เกิดข้อผิดพลาด', `ไม่สามารถส่งข้อมูลได้: ${error.message}`);
							resetFullForm();
                        } finally {
                            if (Swal.isLoading()) Swal.close(); // Ensure loading Swal closes
                            isSubmitting = false;
                            if (fetchSuccess && successData) { // Show success message
                                if (successData.status === 'มา' && successData.photoDataUrl) {
                                    showSuccessSweetAlert(successData.thaiDateTime, teacherDataCache?.name || 'N/A', successData.photoDataUrl);
                                } else {
                                    showSweetAlert('success', 'บันทึกข้อมูลสำเร็จ', `สถานะ: ${successData.status}<br>วันที่/เวลา: ${successData.thaiDateTime}<br>ผู้บันทึก: ${teacherDataCache?.name || 'N/A'}`);
                                }
                                resetFullForm();
                            }
                            // No else needed, error was shown in catch
                        } // End finally
                    } else { console.log("User cancelled submission."); }
                }); // End confirmation Swal .then
            }); // End submit event listener

            // 13. Utility Functions
            function resetFullForm() {
                console.log(">>> resetFullForm called"); // LOG
                checkinForm.reset();
                hideAllSections(); // Hides sections, clears cache, etc.
                // hideAllSections already handles most resets, add anything missed if needed
                window.scrollTo({ top: 0, behavior: 'smooth' });
                updateClockAndButtonState();
            }

        }); // End DOMContentLoaded
    </script>

</body>
</html>
