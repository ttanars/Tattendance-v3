<!DOCTYPE html>
<html lang="th">
<head>
     <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC|‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô v1</title>
    <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        #schoolLogo { max-height: 80px; width: auto; border-radius: 8px; }
        #clock { font-size: 1.1rem; font-weight: bold; }
        .teacher-photo { max-width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid #dee2e6; }
        .signature-pad-container { position: relative; width: 100%; height: 180px; background-color: #ffffff; cursor: crosshair; border: 1px solid #ced4da; border-radius: 0.375rem; }
        #signatureCanvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-radius: 0.375rem; }
        #videoFeed { width: 100%; height: auto; max-height: 240px; display: block; background-color: #343a40; }
        .captured-photo { max-height: 240px; display: block; margin-left: auto; margin-right: auto; background-color: #e9ecef; }
        .form-label { margin-bottom: 0.5rem; }
        .btn-group-camera button { margin: 0 5px; }
        /* CSS for Hiding/Showing Sections */
        .form-section {
             transition: opacity 0.4s ease-in-out, max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out, margin-bottom 0.4s ease-in-out;
             opacity: 0; max-height: 0; overflow: hidden;
             border-top: none; padding-top: 0 !important; margin-top: 0 !important;
             padding-bottom: 0 !important; margin-bottom: 0 !important; position: relative;
        }
        .form-section.visible {
            opacity: 1; max-height: 1500px; overflow: visible;
            border-top: 1px solid #dee2e6; padding-top: 1rem !important; margin-top: 1rem !important;
            padding-bottom: 1rem !important; margin-bottom: 0 !important;
        }
        #teacherInfo.visible {
            border-top: none; padding-top: 1rem !important; margin-top: 1rem !important;
            padding: 1rem; border: 1px solid #dee2e6; background-color: #f8f9fa; border-radius: .25rem;
        }
        #dutyStatusSection.visible { border-top: none; margin-top: 1rem !important; }
        #dutyTypeSection.visible, #remarksSection.visible { border-top: 1px solid #dee2e6; max-height: 500px; }
        #teacherLookupStatus { min-height: 1.2em; display: block; }
        .section-loading-overlay {
             position: absolute; top: 0; left: 0; right: 0; bottom: 0;
             background-color: rgba(255, 255, 255, 0.7); z-index: 10;
             display: flex; align-items: center; justify-content: center;
             opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .section-loading-overlay.visible { opacity: 1; pointer-events: all; }

        @media (max-width: 767.98px) {
            .teacher-photo { max-width: 100px; height: 100px; margin-bottom: 1rem; }
            #videoFeed, .captured-photo { max-height: 180px; }
            .signature-pad-container { height: 140px; }
        }
    </style>
</head>
<body>

    <div class="container mt-4 mb-5">
        <div class="card shadow-sm border-primary">
            <div class="card-header text-center bg-primary text-white p-3">
                <img src="https://lh5.googleusercontent.com/d/1kefVKvkBvHwQf6b5-X64He_L43uJKR5M" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á" id="schoolLogo" class="mb-2 img-fluid">
                <h5 class="mb-1 mt-1 small"><b>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</b></h5>
				 <h6 class="mb-1 mt-2"><b>[‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ]</b></h6>
                <p class="mb-1 mt-1 small">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡∏™‡∏û‡∏°.‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤</p>
            </div>
            <div class="card-body p-4">
			
			    <div id="info" style="font-size:14px"  class="alert alert-warning text-left shadow-sm" role="alert">
                    <i class="fas fa-clock me-2"></i><b> ‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</b>
					<br>1. <b>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ñ‡∏∑‡∏≠ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</b></br>
                    2. <b>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏ï‡∏π </b> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤ : <b>06:50-07.10 ‡∏ô.</b> || ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô : <b>16:20-17.10 ‡∏ô.</b></br> 
					3. <b>‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ >></b> ‡πÄ‡∏ä‡πâ‡∏≤ : <b>08:15-08.30 ‡∏ô.</b> || ‡πÄ‡∏¢‡πá‡∏ô : <b>16:20-17.10 ‡∏ô.</b></br> 
                    4. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üëâ <a style="color:#000;cursor:pointer" target="_blank" href="https://line.me/ti/p/3F7VGrqgUr">‡∏≠.‡∏ò‡∏ô‡∏™‡∏≤‡∏£ ‡∏™‡∏µ‡∏£‡∏±‡∏Å‡∏©‡πå </a>
                </div>
		
                <div id="clock" class="alert alert-info text-center shadow-sm" role="alert">
                    <i class="fas fa-clock me-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
                </div>

                <form id="checkinForm" novalidate>
                    <div class="mb-3">
                        <label for="teacherId" class="form-label fw-bold"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏ï‡∏±‡∏ß)</label>
                        <input type="text" class="form-control" id="teacherId" name="teacherId" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π 4 ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" maxlength="4" >
                        <div id="teacherLookupStatus" class="form-text mt-1"></div>
                    </div>

                    <div id="teacherInfo" class="form-section mb-0">
                         <div class="row align-items-center">
                            <div class="col-md-3 text-center mb-3 mb-md-0">
                                <img src="https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" id="teacherPhoto" class="teacher-photo">
                            </div>
                            <div class="col-md-9">
                                <p class="mb-1"><strong><i class="fas fa-user me-2"></i>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="teacherName"></span></p>
                                <p class="mb-1"><strong><i class="fas fa-chalkboard-teacher me-2"></i>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø:</strong> <span id="teacherDepartment"></span></p>
                                <p class="mb-0"><strong><i class="fas fa-user-tie me-2"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> <span id="teacherPosition"></span></p>
                                <input type="hidden" id="hiddenTeacherName" name="teacherName">
                                <input type="hidden" id="hiddenTeacherDepartment" name="teacherDepartment">
                            </div>
                        </div>
                    </div>

                    <div id="dutyStatusSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-clipboard-check me-2 text-primary"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusPresent" value="‡∏°‡∏≤" required>
                            <label class="form-check-label" for="statusPresent"> <i class="fas fa-user-check text-success me-1"></i> ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusLeave" value="‡∏•‡∏≤">
                            <label class="form-check-label" for="statusLeave"> <i class="fas fa-calendar-times text-warning me-1"></i> ‡∏•‡∏≤ </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyStatus" id="statusBusinessTrip" value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">
                            <label class="form-check-label" for="statusBusinessTrip"> <i class="fas fa-plane-departure text-info me-1"></i> ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ </label>
                        </div>
                         <div id="dutyStatusError" class="invalid-feedback d-block"></div>
                         <div class="section-loading-overlay" id="dutySubSectionsLoading">
                            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                         </div>
                    </div>

                    <div id="dutyTypeSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-tasks me-2 text-secondary"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyType" id="dutyGate" value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">
                            <label class="form-check-label" for="dutyGate"> <i class="fas fa-door-open text-success me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dutyType" id="dutyBuilding" value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">
                            <label class="form-check-label" for="dutyBuilding"> <i class="fas fa-building text-warning me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ </label>
                        </div>
                        <div id="dutyTypeError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="remarksSection" class="form-section">
                        <label for="remarks" class="form-label fw-bold"><i class="fas fa-pencil-alt me-2 text-secondary"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</label>
                        <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£"></textarea>
                        <div id="remarksError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="locationSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-map-marker-alt me-2 text-danger"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <div id="locationInfo" class="form-control" style="min-height: 40px; background-color: #e9ecef;">
                            <span class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1" id="getLocationBtn" title="‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"> <i class="fas fa-sync"></i> </button>
                        </div>
                        <input type="hidden" id="latitude" name="latitude"> <input type="hidden" id="longitude" name="longitude">
                        <div id="locationError" class="form-text text-danger mt-1"></div>
                    </div>

                    <div id="signatureSection" class="form-section">
                         <label for="signatureCanvas" class="form-label fw-bold"><i class="fas fa-signature me-2 text-success"></i>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</label>
                         <div class="signature-pad-container"> <canvas id="signatureCanvas"></canvas> </div>
                         <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="resetSignatureBtn"><i class="fas fa-eraser me-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                         <input type="hidden" id="signatureData" name="signatureData">
                         <div id="signatureError" class="invalid-feedback d-block"></div>
                    </div>

                    <div id="photoSection" class="form-section">
                        <label class="form-label fw-bold"><i class="fas fa-camera me-2 text-info"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô</label>
                        <div class="row g-3 align-items-start">
                            <div class="col-md-6">
                                <video id="videoFeed" playsinline autoplay muted class="img-fluid border rounded bg-dark"></video>
                                <canvas id="photoCanvas" style="display:none;"></canvas>
                            </div>
                            <div class="col-md-6 text-center">
                                <img id="capturedPhotoPreview" src="https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢" class="img-fluid border rounded mb-2 captured-photo">
                                <input type="hidden" id="photoData" name="photoData">
                            </div>
                        </div>
                        <div class="mt-2 text-center btn-group-camera">
                            <button type="button" class="btn btn-sm btn-info" id="startCameraBtn"><i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                            <button type="button" class="btn btn-sm btn-success" id="capturePhotoBtn" disabled><i class="fas fa-camera-retro me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetPhotoBtn" disabled><i class="fas fa-undo me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                        <div id="cameraError" class="form-text text-danger mt-1 text-center"></div>
                        <div id="photoError" class="invalid-feedback d-block text-center"></div>
                    </div>

                    <div id="submitButtonSection" class="form-section d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-secondary btn-lg fw-bold shadow" id="submitBtn" disabled>
                           <i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
                        </button>
                    </div>

                    <div id="statusMessage" class="mt-3"></div>
<center><a style="color:black;text-decoration:none;font-size:14px"><b>üë®‚Äçüíº‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô : </b></a>
      <a href="https://www.freecounterstat.com" title="hit counters for websites"><img src="https://counter4.optistats.ovh/private/freecounterstat.php?c=uxl7ktjxcfulq4s18eams772gxzgjehu" border="0" title="free hit counter" alt="free hit counter"></a></center>
                </form>
            </div>
             <!--<div class="card-footer text-muted text-center small p-2">
                 ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á
            </div>--> 
			
			<div class="card-footer text-muted text-center small p-2">
                <a style="color:red;text-decoration:none;font-size:14px"
                        href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments fa-bounce"></i> ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô || ¬©Ô∏èKT|Tanasarn Sirak</a>
			</div>
			
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6x9J97SpnwCXeClAPtOo7Vf6vDmKZRWIMlK-i7VdWcuO9byOG7J3Th8G1m4uBsk8EEw/exec'; // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á !!!
            //const TEACHER_LOOKUP_URL = SCRIPT_URL + '?action=getTeacherInfo&id=';
            //const MORNING_START_TIME = "06:50"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            //const MORNING_END_TIME = "07:10";   // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            //const AFTERNOON_START_TIME = "16:20"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
            //const AFTERNOON_END_TIME = "17:10"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
			
			const TEACHER_LOOKUP_URL = SCRIPT_URL + '?action=getTeacherInfo&id=';
            const MORNING_START_TIME = "06:50"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            const MORNING_END_TIME = "07:10";   // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            const AFTERNOON_START_TIME = "13:20"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
            const AFTERNOON_END_TIME = "23:10"; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
			
			
            // const ALLOWED_DAYS = [0, 1, 2, 3, 4, 5]; // ‡πÄ‡∏õ‡∏¥‡∏î comment ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏±‡∏ô ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå

            // --- DOM ELEMENTS ---
            const clockElement = document.getElementById('clock');
            const checkinForm = document.getElementById('checkinForm');
            const teacherIdInput = document.getElementById('teacherId');
            const teacherLookupStatus = document.getElementById('teacherLookupStatus');
            const teacherInfoDiv = document.getElementById('teacherInfo');
            const dutyStatusSection = document.getElementById('dutyStatusSection');
            const dutyTypeSection = document.getElementById('dutyTypeSection');
            const remarksSection = document.getElementById('remarksSection');
            const locationSection = document.getElementById('locationSection');
            const signatureSection = document.getElementById('signatureSection');
            const photoSection = document.getElementById('photoSection');
            const submitButtonSection = document.getElementById('submitButtonSection');
            const dutySubSectionsLoading = document.getElementById('dutySubSectionsLoading');
            const teacherPhoto = document.getElementById('teacherPhoto');
            const teacherNameSpan = document.getElementById('teacherName');
            const teacherDepartmentSpan = document.getElementById('teacherDepartment');
            const teacherPositionSpan = document.getElementById('teacherPosition');
            const hiddenTeacherName = document.getElementById('hiddenTeacherName');
            const hiddenTeacherDepartment = document.getElementById('hiddenTeacherDepartment');
            const dutyStatusRadios = document.querySelectorAll('input[name="dutyStatus"]');
            const dutyTypeRadios = document.querySelectorAll('input[name="dutyType"]');
            const remarksInput = document.getElementById('remarks');
            const dutyStatusErrorDiv = document.getElementById('dutyStatusError');
            const dutyTypeErrorDiv = document.getElementById('dutyTypeError');
            const remarksErrorDiv = document.getElementById('remarksError');
            const locationInfoDiv = document.getElementById('locationInfo');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const locationErrorDiv = document.getElementById('locationError');
            const signatureCanvas = document.getElementById('signatureCanvas');
            const resetSignatureBtn = document.getElementById('resetSignatureBtn');
            const signatureDataInput = document.getElementById('signatureData');
            const signatureErrorDiv = document.getElementById('signatureError');
            const videoFeed = document.getElementById('videoFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const capturedPhotoPreview = document.getElementById('capturedPhotoPreview');
            const photoDataInput = document.getElementById('photoData');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const resetPhotoBtn = document.getElementById('resetPhotoBtn');
            const cameraErrorDiv = document.getElementById('cameraError');
            const photoErrorDiv = document.getElementById('photoError');
            const submitBtn = document.getElementById('submitBtn');
            const statusMessage = document.getElementById('statusMessage');

            // --- STATE VARIABLES ---
            let signaturePad; let stream = null; let teacherDataCache = null;
            let locationWatcher = null; let isSubmitting = false;
            let checkinAllowed = false; let currentCheckinWindow = null;
            let locationAcquired = false;

            // --- INITIALIZATION ---
            initializeClock(); initializeSignaturePad();
            setInterval(updateClockAndButtonState, 1000);
            window.addEventListener('resize', resizeCanvas);
            addCompletionCheckListeners(); hideAllSections();

            // --- FUNCTIONS ---

            // 1. Clock and Time Check
            function initializeClock() { updateClockAndButtonState(); }
            function isWithinWindow(currentTimeStr, startTimeStr, endTimeStr) { return currentTimeStr >= startTimeStr && currentTimeStr <= endTimeStr; }
            function updateClockAndButtonState() {
                if (isSubmitting) return; const now = new Date();
                const year = now.getFullYear() + 543; const optsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const optsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                const thaiDate = now.toLocaleDateString('th-TH', optsDate).replace(String(now.getFullYear()), String(year));
                const thaiTime = now.toLocaleTimeString('th-TH', optsTime);
                clockElement.innerHTML = `<i class="fas fa-clock me-2"></i> ${thaiDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${thaiTime} ‡∏ô.`;
                const currentDay = now.getDay();
                const currentTimeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
                // const isWorkingDay = typeof ALLOWED_DAYS !== 'undefined' ? ALLOWED_DAYS.includes(currentDay) : true;
                const isWorkingDay = true; // Assume everyday
                checkinAllowed = false; currentCheckinWindow = null;
                if (isWorkingDay) {
                    if (isWithinWindow(currentTimeStr, MORNING_START_TIME, MORNING_END_TIME)) { checkinAllowed = true; currentCheckinWindow = 'morning'; }
                    else if (isWithinWindow(currentTimeStr, AFTERNOON_START_TIME, AFTERNOON_END_TIME)) { checkinAllowed = true; currentCheckinWindow = 'afternoon'; }
                }
                updateSubmitButtonDisplay();
            }

            // 2. Teacher ID Input & Lookup Trigger
            teacherIdInput.addEventListener('input', handleTeacherIdInput);
            teacherIdInput.addEventListener('paste', (e) => { setTimeout(handleTeacherIdInput, 0); });
            function handleTeacherIdInput() {
                 const currentVal = teacherIdInput.value.trim(); teacherIdInput.value = currentVal;
                 if (currentVal.length === 4) { showLoadingAndFetch(currentVal); }
                 else { if (teacherDataCache) { hideAllSections(); teacherLookupStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏ï‡∏±‡∏ß'; } }
            }
            function showLoadingAndFetch(teacherId) {
                 teacherLookupStatus.textContent = '';
                 Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`, allowOutsideClick: false, allowEscapeKey: false, didOpen: () => { Swal.showLoading(); } });
                 hideAllSections(false); fetchTeacherData(teacherId);
            }
            async function fetchTeacherData(teacherId) {
                 if (!teacherId) { Swal.close(); return; } teacherDataCache = null;
                 if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') { Swal.close(); showSweetAlert('error', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Apps Script'); return; }
                try {
                    const lookupUrl = `${TEACHER_LOOKUP_URL}${encodeURIComponent(teacherId)}`; const response = await fetch(lookupUrl); Swal.close();
                    if (!response.ok) throw new Error(`Server Connection Error (${response.status})`);
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) { const text = await response.text(); console.error("Non-JSON:", text); throw new Error("Invalid server response"); }
                    const data = await response.json(); if (data.error) throw new Error(data.error);
                    if (data.found && data.teacher) {
                        teacherDataCache = data.teacher; console.log('>>> teacherDataCache SET:', teacherDataCache);
                        teacherNameSpan.textContent = data.teacher.name || 'N/A'; teacherDepartmentSpan.textContent = data.teacher.department || 'N/A';
                        teacherPositionSpan.textContent = data.teacher.position || 'N/A';
                        teacherPhoto.src = data.teacher.photoUrl || 'https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9';
                        hiddenTeacherName.value = data.teacher.name || ''; hiddenTeacherDepartment.value = data.teacher.department || '';
                        showBaseInfoAndDutyStatus(); showSweetAlert('success', '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π', `‡∏ä‡∏∑‡πà‡∏≠: ${data.teacher.name || 'N/A'}`);
                    } else { throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ'); }
                } catch (error) { Swal.close(); console.error('Fetch Error:', error); showSweetAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message); hideAllSections(); teacherIdInput.focus(); teacherDataCache = null; }
            }

            // 3. Show/Hide Sections Logic
            function showBaseInfoAndDutyStatus() {
                teacherInfoDiv.classList.add('visible'); dutyStatusSection.classList.add('visible');
                dutyStatusRadios.forEach(radio => radio.checked = false);
                dutyTypeSection.classList.remove('visible'); remarksSection.classList.remove('visible');
                locationSection.classList.remove('visible'); signatureSection.classList.remove('visible');
                photoSection.classList.remove('visible'); submitButtonSection.classList.remove('visible');
            }
            function hideAllSections(clearTeacherId = true) {
                console.log(`>>> hideAllSections called (clearTeacherId=${clearTeacherId})`);
                document.querySelectorAll('.form-section').forEach(s => s.classList.remove('visible'));
                if (teacherDataCache) { teacherDataCache = null; console.log('>>> teacherDataCache CLEARED by hideAllSections'); }
                hiddenTeacherName.value = ''; hiddenTeacherDepartment.value = ''; locationAcquired = false;
                if (clearTeacherId) { teacherIdInput.value = ''; teacherLookupStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏ï‡∏±‡∏ß'; }
                clearValidationErrors(); statusMessage.innerHTML = ''; stopCameraStream();
                if (signaturePad) signaturePad.clear(); signatureDataInput.value = ''; photoDataInput.value = '';
                latitudeInput.value = ''; longitudeInput.value = ''; locationInfoDiv.querySelector('span').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...'; // Reset location text
                capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';
                startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'; capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true;
            }

            // 4. Duty Status Change Handler
            dutyStatusRadios.forEach(radio => { radio.addEventListener('change', handleDutyStatusChange); });
            async function handleDutyStatusChange() {
                 const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;
                 clearValidationErrors(['dutyStatusError']); dutySubSectionsLoading.classList.add('visible');
                 dutyTypeSection.classList.remove('visible'); remarksSection.classList.remove('visible');
                 locationSection.classList.remove('visible'); signatureSection.classList.remove('visible');
                 photoSection.classList.remove('visible'); submitButtonSection.classList.remove('visible');
                 dutyTypeRadios.forEach(r => { r.checked = false; r.required = false; }); remarksInput.value = ''; remarksInput.required = false;
                 locationAcquired = false; if (signaturePad) signaturePad.clear(); signatureDataInput.value = ''; photoDataInput.value = '';
                 latitudeInput.value = ''; longitudeInput.value = ''; locationInfoDiv.querySelector('span').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
                 capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';
                 startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'; capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true; stopCameraStream();
                 await new Promise(resolve => setTimeout(resolve, 50));
                 if (selectedStatus === '‡∏°‡∏≤') {
                     dutyTypeSection.classList.add('visible'); locationSection.classList.add('visible');
                     signatureSection.classList.add('visible'); photoSection.classList.add('visible');
                     remarksSection.classList.remove('visible'); dutyTypeRadios.forEach(r => r.required = true); remarksInput.required = false;
                     initializeGeolocation(); resizeCanvas(); // User needs to click "Start Camera"
                 } else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                     remarksSection.classList.add('visible'); dutyTypeSection.classList.remove('visible');
                     locationSection.classList.remove('visible'); signatureSection.classList.remove('visible'); photoSection.classList.remove('visible');
                     dutyTypeRadios.forEach(r => r.required = false); remarksInput.required = true;
                 }
                 dutySubSectionsLoading.classList.remove('visible'); checkFormCompletion();
            }

            // 5. Geolocation
            getLocationBtn.addEventListener('click', initializeGeolocation);
            function initializeGeolocation() {
                if (!locationSection.classList.contains('visible')) return; locationInfoDiv.querySelector('span').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
                locationErrorDiv.textContent = ''; latitudeInput.value = ''; longitudeInput.value = ''; locationAcquired = false; clearValidationErrors(['locationError']); checkFormCompletion();
                if ('geolocation' in navigator) {
                     if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                     navigator.geolocation.getCurrentPosition(
                         (pos) => {
                             latitudeInput.value = pos.coords.latitude; longitudeInput.value = pos.coords.longitude; locationAcquired = true; checkFormCompletion();
                             locationInfoDiv.querySelector('span').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                             const mapLink = `https://www.google.com/maps?q=$$${pos.coords.latitude},${pos.coords.longitude}`; let link = locationInfoDiv.querySelector('a');
                             if (!link) { link = document.createElement('a'); link.target = '_blank'; link.rel = 'noopener noreferrer'; link.classList.add('ms-2', 'small'); link.innerHTML = '<i class="fas fa-external-link-alt"></i> ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'; locationInfoDiv.appendChild(link); } link.href = mapLink;
                         },
                         (err) => { handleLocationError(err); locationAcquired = false; checkFormCompletion(); }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                     );
                } else { handleLocationError({ code: -1, message: 'Geolocation not supported' }); locationAcquired = false; checkFormCompletion(); }
            }
            function handleLocationError(error) {
                 console.error('Geolocation Error:', error); let msg = 'Location Error: ';
                 switch (error.code) { case error.PERMISSION_DENIED: msg += 'User denied request.'; break; case error.POSITION_UNAVAILABLE: msg += 'Location unavailable.'; break; case error.TIMEOUT: msg += 'Timeout.'; break; case -1: msg = error.message; break; default: msg += 'Unknown error.'; break; }
                 locationInfoDiv.querySelector('span').textContent = 'Location Error'; locationErrorDiv.textContent = msg; latitudeInput.value = ''; longitudeInput.value = '';
            }

            // 6. Signature Pad
            function initializeSignaturePad() {
                 resizeCanvas(); signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                 resetSignatureBtn.addEventListener('click', () => { signaturePad.clear(); signatureDataInput.value = ''; clearValidationErrors(['signatureError']); checkFormCompletion(); });
                 signatureCanvas.addEventListener('pointerdown', () => { clearValidationErrors(['signatureError']); });
                 signaturePad.addEventListener("endStroke", () => { signatureDataInput.value = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/jpeg', 0.85).split(',')[1]; checkFormCompletion(); });
            }
            function resizeCanvas() {
                 if (!signatureCanvas.offsetParent) return; const r = Math.max(window.devicePixelRatio || 1, 1); const c = signatureCanvas.parentElement; if (!c || c.offsetWidth === 0) return;
                 signatureCanvas.width = c.offsetWidth * r; signatureCanvas.height = c.offsetHeight * r; signatureCanvas.getContext("2d").scale(r, r);
                 if (signaturePad) { const d = signaturePad.toData(); signaturePad.clear(); signaturePad.fromData(d); }
            }

            // 7. Camera Functionality
            function stopCameraStream() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; videoFeed.srcObject = null; console.log("Camera stopped."); } }
            startCameraBtn.addEventListener('click', startCamera); capturePhotoBtn.addEventListener('click', capturePhoto); resetPhotoBtn.addEventListener('click', resetPhoto);
            async function startCamera() {
                if (!photoSection.classList.contains('visible')) return; cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = ''; clearValidationErrors(['cameraError', 'photoError']);
                stopCameraStream(); await new Promise(resolve => setTimeout(resolve, 100));
                try {
                     stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false }); videoFeed.srcObject = stream; videoFeed.style.display = 'block';
                     capturePhotoBtn.disabled = false; resetPhotoBtn.disabled = true; startCameraBtn.innerHTML = '<i class="fas fa-sync me-1"></i> ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                     capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E'; photoDataInput.value = ''; checkFormCompletion();
                 } catch (err) { console.error("Cam Err:", err); let msg = `Cam Err: ${err.name}`; /*...*/ cameraErrorDiv.textContent = msg; capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true; startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'; videoFeed.style.display = 'none'; stopCameraStream(); checkFormCompletion(); }
             }
            function capturePhoto() {
                 if (!stream || !stream.active) { cameraErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô'; return; } clearValidationErrors(['photoError']);
                 const now = new Date(); const currentTimeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }); let isCaptureTimeAllowed = false;
                 if (isWithinWindow(currentTimeStr, MORNING_START_TIME, MORNING_END_TIME) || isWithinWindow(currentTimeStr, AFTERNOON_START_TIME, AFTERNOON_END_TIME)) { isCaptureTimeAllowed = true; }
                 if (!isCaptureTimeAllowed) {
                     showSweetAlert('warning', '‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', `‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á<br>‡πÄ‡∏ä‡πâ‡∏≤: ${MORNING_START_TIME} - ${MORNING_END_TIME} ‡∏ô.<br>‡πÄ‡∏¢‡πá‡∏ô: ${AFTERNOON_START_TIME} - ${AFTERNOON_END_TIME} ‡∏ô.`);
                     return; // Stop if outside time
                 }
                 const vw = videoFeed.videoWidth; const vh = videoFeed.videoHeight; if (!vw || !vh) { cameraErrorDiv.textContent = 'Video size error'; return; }
                 photoCanvas.width = vw; photoCanvas.height = vh; const ctx = photoCanvas.getContext('2d'); ctx.drawImage(videoFeed, 0, 0, vw, vh); const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.85);
                 capturedPhotoPreview.src = dataUrl; photoDataInput.value = dataUrl.split(',')[1]; resetPhotoBtn.disabled = false; capturePhotoBtn.disabled = true; checkFormCompletion();
            }
            function resetPhoto() {
                 clearValidationErrors(['photoError']); photoDataInput.value = '';
                 capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E';
                 photoCanvas.getContext('2d').clearRect(0, 0, photoCanvas.width, photoCanvas.height); resetPhotoBtn.disabled = true;
                 if (stream && stream.active) { capturePhotoBtn.disabled = false; } else { capturePhotoBtn.disabled = true; } checkFormCompletion();
            }

            // 8. Form Completion Check
            function addCompletionCheckListeners() { dutyTypeRadios.forEach(r => r.addEventListener('change', checkFormCompletion)); remarksInput.addEventListener('input', checkFormCompletion); }
            function checkFormCompletion() {
                const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value; let isComplete = false;
                if (selectedStatus === '‡∏°‡∏≤') { const dutyTypeSel = document.querySelector('input[name="dutyType"]:checked'); const sigDone = !signaturePad.isEmpty() && signatureDataInput.value; const photoTaken = photoDataInput.value; isComplete = dutyTypeSel && latitudeInput.value && longitudeInput.value && sigDone && photoTaken; }
                else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') { isComplete = remarksInput.value.trim() !== ''; }
                if (isComplete) { submitButtonSection.classList.add('visible'); } else { submitButtonSection.classList.remove('visible'); } updateSubmitButtonDisplay();
            }

            // 9. Update Submit Button Display
            function updateSubmitButtonDisplay() {
                 if (!submitButtonSection.classList.contains('visible')) { submitBtn.disabled = true; return; }
                 if (checkinAllowed) { submitBtn.disabled = false; submitBtn.classList.replace('btn-secondary','btn-primary'); const winTxt = currentCheckinWindow === 'morning' ? '‡πÄ‡∏ä‡πâ‡∏≤' : (currentCheckinWindow === 'afternoon' ? '‡∏ö‡πà‡∏≤‡∏¢' : ''); submitBtn.innerHTML = `<i class="fas fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${winTxt ? '(‡∏£‡∏≠‡∏ö' + winTxt + ')' : ''}`; }
                 else { submitBtn.disabled = true; submitBtn.classList.replace('btn-primary','btn-secondary'); submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (${MORNING_START_TIME}-${MORNING_END_TIME} ‡∏´‡∏£‡∏∑‡∏≠ ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME})`; }
            }

            // 10. Form Validation (Final Check)
            function validateForm() {
                clearValidationErrors(); let isValid = true; const statusRadio = document.querySelector('input[name="dutyStatus"]:checked'); const statusVal = statusRadio ? statusRadio.value : null;
                if (!teacherDataCache) { showSweetAlert('warning', 'Error', 'Teacher data missing'); isValid = false; }
                else if (!statusVal) { dutyStatusErrorDiv.textContent = 'Choose status'; isValid = false; }
                else if (statusVal === '‡∏°‡∏≤') {
                    if (!document.querySelector('input[name="dutyType"]:checked')) { dutyTypeErrorDiv.textContent = 'Choose duty type'; isValid = false; }
                    else if (!latitudeInput.value || !longitudeInput.value) { locationErrorDiv.textContent = 'Location missing'; isValid = false; }
                    else if (signaturePad.isEmpty() || !signatureDataInput.value) { signatureErrorDiv.textContent = 'Signature missing'; isValid = false; }
                    else if (!photoDataInput.value) { photoErrorDiv.textContent = 'Photo missing'; isValid = false; }
                } else if ((statusVal === '‡∏•‡∏≤' || statusVal === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') && !remarksInput.value.trim()) { remarksErrorDiv.textContent = 'Remarks missing'; isValid = false; }
                if (isValid && !checkinAllowed) { showSweetAlert('warning', 'Out of Time', `Allowed: ${MORNING_START_TIME}-${MORNING_END_TIME} or ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME}`); isValid = false; }
                if (!isValid) { const firstErr = checkinForm.querySelector('.form-text.text-danger:not(:empty), .invalid-feedback:not(:empty)'); firstErr?.closest('.form-section')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                return isValid;
            }
            function clearValidationErrors(exceptIds = []) { const errDivs = checkinForm.querySelectorAll('.form-text.text-danger, .invalid-feedback'); errDivs.forEach(d => { if (!exceptIds.includes(d.id)) d.textContent = ''; }); }

            // 11. SweetAlert Helpers
            function showSweetAlert(icon, title, html = '') { Swal.fire({ icon: icon, title: title, html: html, confirmButtonText: 'Close' }); }
            function showSuccessSweetAlert(checkinTime, teacherName, photoUrl) { Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', html: `<p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${checkinTime}</p><p><strong>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${teacherName}</p>${photoUrl ? `<img src="${photoUrl}" alt="Check-in Photo" style="max-width:150px; max-height:150px; margin-top:10px; border-radius:5px;">` : ''}`, confirmButtonText: 'Close' }); }

            // 12. Form Submission
            checkinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!checkinAllowed) { showSweetAlert('warning', 'Out of Time', `Allowed: ${MORNING_START_TIME}-${MORNING_END_TIME} or ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME}`); return; }
                if (!validateForm()) { /* Validation shows its own alert */ return; }
                if (!SCRIPT_URL || SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') { showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set'); return; }

                Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', html: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", icon: 'question', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: ' ‡πÉ‡∏ä‡πà, ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, allowEscapeKey: false, didOpen: () => Swal.showLoading() });
                        isSubmitting = true; statusMessage.innerHTML = ''; const formData = new FormData(checkinForm);
                        if (formData.get('dutyStatus') === '‡∏°‡∏≤' && !signaturePad.isEmpty()) { formData.set('signatureData', signaturePad.toDataURL('image/jpeg', 0.85).split(',')[1]); } else if (formData.get('dutyStatus') !== '‡∏°‡∏≤') { formData.set('signatureData', ''); }
                        const status = formData.get('dutyStatus');
                        if (status !== '‡∏°‡∏≤') { formData.delete('dutyType'); formData.delete('latitude'); formData.delete('longitude'); formData.delete('signatureData'); formData.delete('photoData'); } else { formData.delete('remarks'); }
                        formData.append('clientTimestamp', new Date().toISOString());

                        let fetchSuccess = false; let successData = null;
                        try {
                            const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData }); const contentType = response.headers.get("content-type"); let fetchResult;
                            if (contentType && contentType.includes("application/json")) { fetchResult = await response.json(); } else { const text = await response.text(); throw new Error(text || `Server Error ${response.status}`); }
                            if (fetchResult.status === 'success') {
                                fetchSuccess = true; const now = new Date(); const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                                const thaiDateTime = now.toLocaleDateString('th-TH', opts).replace(String(now.getFullYear()), String(now.getFullYear() + 543));
                                const photoDataUrl = formData.get('photoData') ? `data:image/jpeg;base64,${formData.get('photoData')}` : null;
                                successData = { thaiDateTime, status, photoDataUrl };
                            } else { throw new Error(fetchResult.message || 'Unknown server error'); }
                        } catch (error) { console.error('Submit Error:', error); if (Swal.isLoading()) Swal.close(); showSweetAlert('error', 'Submit Failed', `Error: ${error.message}`);
                        } finally {
                            if (Swal.isLoading()) Swal.close(); isSubmitting = false;
                            if (fetchSuccess && successData) {
                                if (successData.status === '‡∏°‡∏≤' && successData.photoDataUrl) { showSuccessSweetAlert(successData.thaiDateTime, teacherDataCache?.name || 'N/A', successData.photoDataUrl); }
                                else { showSweetAlert('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${successData.status}<br>‡πÄ‡∏ß‡∏•‡∏≤: ${successData.thaiDateTime}<br>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${teacherDataCache?.name || 'N/A'}`); }
                                resetFullForm();
                            }
                        } // End finally
                    } else { console.log("User cancelled submission."); }
                }); // End confirmation Swal .then
            }); // End submit event listener

            // 13. Utility Functions
            function resetFullForm() { console.log(">>> resetFullForm called"); checkinForm.reset(); hideAllSections(); window.scrollTo({ top: 0, behavior: 'smooth' }); updateClockAndButtonState(); }

        }); // End DOMContentLoaded
    </script>

</body>
</html>
